<!DOCTYPE html>

<html lang="en">
<head>
    <meta charset="utf-8" />
    <title>4 the lolz</title>
    <style>
        @import url(style.css);

.background {
    stroke: white;
    stroke-width: 1px;
    fill: white;
}

.node {
  stroke: black;
  stroke-width: 1px;
    cursor: move;
  fill: beige;
}

.core {
  stroke: black;
  stroke-width: 1px;
    cursor: move;
  fill: beige;
}

.synchronizer {
  stroke: black;
  stroke-width: 1px;
    cursor: move;
  fill: red;
}

.link {
    fill: none;
    stroke: #000;
    stroke-width: 3px;
    opacity: 0.7;
    marker-end: url(#end-arrow);
}

.linkinvisible {
    fill: none;
    stroke: none;
    //stroke-width: 0px;
    //opacity: 0.7;
}

.label {
    fill: black;
    font-family: Verdana;
    font-size: 16px;
    text-anchor: middle;
    cursor: move;
}

.guideline {
    stroke: orangered;
    stroke-width: 4px;
}

</style>
</head>
<body onload="init()">
<script src="d3.v3.js"></script>
<script src="cola.min.js"></script>
<script>

    // This will be imported from a json file.
    data = {
       nodes: [ 1, 2 ],
       processors : [
          {
             node: 0,
             label: "TableReader",
             extraLines: [ "lol", "meh" ]
          }
       ],
       edges: [
          {
             sourceProc: 0,
             routerIdx: 0,
          }
       ]
    };
           












    var width = 800,
        height = 700;

    var d3cola = cola.d3adaptor()
        .linkDistance(100)
        //.linkDistance(function(link) { return link.distance })
        //.jaccardLinkLengths(50)
        .avoidOverlaps(true)
        .flowLayout('y', 20)
        .size([width, height]);

    var outer = d3.select("body").append("svg")
        .attr("width", width)
        .attr("height", height)
        .attr("pointer-events", "all");

    outer.append('rect')
        .attr('class', 'background')
        .attr('width', "100%")
        .attr('height', "100%")
        .call(d3.behavior.zoom().on("zoom", redraw));

    var vis = outer
        .append('g')
        .attr('transform', 'translate(80,80) scale(0.7)');

    function redraw() {
        vis.attr("transform", "translate(" + d3.event.translate + ")" + " scale(" + d3.event.scale + ")");
    }

    var groupsLayer = vis.append("g");
    var nodesLayer = vis.append("g");
    var linksLayer = vis.append("g");

    var graph = {}, nodeLookup = {};
    function init() {
        graph.nodes = [];
        graph.nodes.push({
            title: "TableReader",
            lines: ["some more info", "even more info"],
            index: 0,
            width: 60,
            height: 40,
            //x: 50,
            //y: 50,
            rx: 10,
            ry: 10,
            type: "core",
        });
        graph.nodes.push({
            title: "Wtf",
            lines: ["some more info", "even more info"],
            index: 0,
            width: 60,
            height: 40,
            //x: 250,
            //y: 50,
            rx: 10,
            ry: 10,
            type: "core",
        });
        graph.nodes.push({
            title: "ordered",
            lines: ["1+,2-"],
            index: 0,
            width: 60,
            height: 40,
            //x: 250,
            //y: 50,
            rx: 10,
            ry: 10,
            type: "synchronizer",
        });
        graph.nodes.push({
            title: "unordered",
            index: 0,
            width: 60,
            height: 40,
            //x: 250,
            //y: 50,
            rx: 10,
            ry: 10,
            type: "synchronizer",
        });
        graph.nodes.push({
            title: "bbq",
            index: 0,
            width: 60,
            height: 40,
            //x: 250,
            //y: 50,
            rx: 10,
            ry: 10,
            type: "core",
        });
        graph.links = [];
        graph.links.push({source: 0, target: 2, distance: 60})
        //graph.links.push({source: 2, target: 1, distance: 1, invisible: true})

        graph.groups = [];
        graph.groups.push({
            nodeID: 1,
            leaves: [0, 1, 2, 3],
            padding: 15,
        });
        graph.groups.push({
            nodeID: 2,
            leaves: [4],
            padding: 15,
        });

        graph.constraints = [];
        //graph.constraints.push({axis: "x", left: 2, right: 1, gap:0, equality: true})
        //graph.constraints.push({axis: "y", left: 2, right: 1, gap:30, equality: true})
        graph.constraints.push({
            type: "alignment", axis: "x",
            offsets: [{node:1, offset:0}, {node:2, offset:-80}, {node:3, offset:+80}]
        })
        graph.constraints.push({
            type: "alignment", axis: "y",
            offsets: [{node:2, offset:0}, {node:1, offset:50}, {node:3, offset:0}]
        })
        //var constraintMap = {};
        //sbsvg.selectAll('[relType=alignment]').each(function () {
        //    var cid = this.attributes['constraintID'].value;
        //    var nodeid = nodeLookup[this.attributes['objOneID'].value].index;
        //    var alignmentPos = this.attributes['alignmentPos'].value;
        //    var o = { node: nodeid, offset: 0 };
        //    if (cid in constraintMap) {
        //        constraintMap[cid].offsets.push(o);
        //    } else {
        //        graph.constraints.push(constraintMap[cid] = {
        //            type: 'alignment',
        //            offsets: [o],
        //            axis: alignmentPos == 1 ? "y" : "x"
        //        });
        //    }
        //});

        var color = d3.scale.category20();

        d3cola
            .nodes(graph.nodes)
            .links(graph.links)
            .groups(graph.groups)
            .constraints(graph.constraints)
            .start();//10, 15, 40);

        // define arrow markers for graph links
        outer.append('svg:defs').append('svg:marker')
            .attr('id', 'end-arrow')
            .attr('viewBox', '0 -5 10 10')
            .attr('refX', 5)
            .attr('markerWidth', 3)
            .attr('markerHeight', 3)
            .attr('orient', 'auto')
          .append('svg:path')
            .attr('d', 'M0,-5L10,0L0,5L2,0')
            .attr('stroke-width', '0px')
            .attr('fill', '#000');

        var group = groupsLayer.selectAll(".group")
            .data(graph.groups)
          .enter().append("rect")
            .attr("rx", 4).attr("ry", 4)
            .attr("class", "group")
            .style("fill-opacity", 0.4)
            //.attr("style", "fill:#ffdd3c;fill-opacity:0.37254902000000001;stroke:#ffdd3c;stroke-opacity:1")
            .style("fill", function (d) { return color(d.nodeID) })
            .call(d3cola.drag);

        var link = linksLayer.selectAll(".link")
            .data(graph.links.filter(function(d) { return !d.invisible } ))
          .enter().append("line")
            .attr("class", "link");
        //var link = linksLayer.selectAll(".link")
        //    .data(graph.links)
        //  .enter().append('svg:path')
        //    .attr("class", "link");

        var margin = 10, pad = 12;
        var node = nodesLayer.selectAll(".node")
            .data(graph.nodes)
          .enter().append("rect")
            .attr("class", function (d) { return d.type })
            .attr("width", function (d) { return d.width + 2 * pad + 2 * margin; })
            .attr("height", function (d) { return d.height + 2 * pad + 2 * margin; })
            .attr("rx", function (d) { return d.rx; }).attr("ry", function (d) { return d.rx; })
            .call(d3cola.drag);

        var label = nodesLayer.selectAll(".label")
            .data(graph.nodes)
           .enter().append("text")
            .attr("class", "label")
            .call(d3cola.drag);

        var setLabels = function (d) {
            var el = d3.select(this);
            el.text("")
            var size = 0
            if (d.type == "core") {
                size = 4
            }

            el.append('tspan').text(d.title)
                .attr('x', 0).attr('dy', 18+size)
                .attr("font-size", 14+size)
                .attr("font-weight", "bold");

            if (!d.lines) {
                return
            }
            for (var i = 0; i < d.lines.length; i++) {
                el.append('tspan').text(d.lines[i])
                    .attr('x', 0).attr('dy', 16+size)
                    .attr("font-size", 12+size);
            }
        };

        label.each(setLabels);

        var groupLabel = vis.selectAll(".groupLabel").data(graph.groups)
            .enter().append("text")
            .attr("font-size", "13")
            .text(function (d) { return "Node " + d.nodeID });

        //node.append("title")
        //    .text(function (d) { return d.title; });

        d3cola.on("tick", function () {
            node.each(function (d) {
                d.innerBounds = d.bounds.inflate(- margin);
            });
            link.each(function (d) {
                d.route = cola.vpsc.makeEdgeBetween(d.source.innerBounds, d.target.innerBounds, 5);
                if (isIE())  this.parentNode.insertBefore(this, this);
            });
            
            link.attr("x1", function (d) { return d.route.sourceIntersection.x; })
                .attr("y1", function (d) { return d.route.sourceIntersection.y; })
                .attr("x2", function (d) { return d.route.arrowStart.x; })
                .attr("y2", function (d) { return d.route.arrowStart.y; });

            label.each(function (d) {
                var b = this.getBBox();
                d.width = b.width + 4 * margin + 8;
                d.height = b.height + 2 * margin + 8;
            });

            node.attr("x", function (d) { return d.innerBounds.x; })
                .attr("y", function (d) { return d.innerBounds.y; })
                .attr("width", function (d) { return d.innerBounds.width(); })
                .attr("height", function (d) { return d.innerBounds.height(); });

            group.attr("x", function (d) { return d.bounds.x; })
                 .attr("y", function (d) { return d.bounds.y; })
                 .attr("width", function (d) { return d.bounds.width(); })
                 .attr("height", function (d) { return d.bounds.height(); });


            groupLabel.data(group.data())
              .attr("x", function(d) { return d.bounds.x + 5})
              .attr("y", function(d) { return d.bounds.y + 15});

            //groupLabel.attr("x", group.data()[0].bounds.x)
            //          .attr("y", group.data()[0].bounds.y);

            label.attr("transform", function (d) {
                return "translate(" + d.x + margin + "," + (d.y + margin - d.height/2) + ")";
            });
        });
    }
    function isIE() { return ((navigator.appName == 'Microsoft Internet Explorer') || ((navigator.appName == 'Netscape') && (new RegExp("Trident/.*rv:([0-9]{1,}[\.0-9]{0,})").exec(navigator.userAgent) != null))); }
</script>
</body>
</html>
