<!DOCTYPE html>

<html lang="en">
<head>
    <meta charset="utf-8" />
    <title>Metabolic pathway</title>
    <style>
        @import url(style.css);

.background {
    stroke: white;
    stroke-width: 1px;
    fill: white;
}

.node {
  stroke: black;
  stroke-width: 1px;
    cursor: move;
  fill: beige;
}

.link {
    fill: none;
    stroke: #000;
    stroke-width: 3px;
    opacity: 0.7;
    marker-end: url(#end-arrow);
}

.linkinternal {
    fill: none;
    stroke: #000;
    stroke-width: 2px;
    opacity: 0.7;
}

.label {
    fill: black;
    font-family: Verdana;
    font-size: 25px;
    text-anchor: middle;
    cursor: move;
}

.guideline {
    stroke: orangered;
    stroke-width: 4px;
}

</style>
</head>
<body onload="parseDunnart()">
<script src="d3.v3.js"></script>
<script src="cola.min.js"></script>
<script>
    var width = 800,
        height = 520;

    var d3cola = cola.d3adaptor()
        .linkDistance(function(link) { return link.distance })
        .avoidOverlaps(true)
        .flowLayout('y', 20)
        .size([width, height]);

    var outer = d3.select("body").append("svg")
        .attr("width", width)
        .attr("height", height)
        .attr("pointer-events", "all");

    outer.append('rect')
        .attr('class', 'background')
        .attr('width', "100%")
        .attr('height', "100%")
        .call(d3.behavior.zoom().on("zoom", redraw));

    var vis = outer
        .append('g')
        .attr('transform', 'translate(80,80) scale(0.7)');

    function redraw() {
        vis.attr("transform", "translate(" + d3.event.translate + ")" + " scale(" + d3.event.scale + ")");
    }

    var groupsLayer = vis.append("g");
    var nodesLayer = vis.append("g");
    var linksLayer = vis.append("g");

    var graph = {}, nodeLookup = {};
    function parseDunnart() {
        graph.nodes = [];
        graph.nodes.push({
            label: "lol",
            index: 0,
            width: 60,
            height: 40,
            //x: 50,
            //y: 50,
            rx: 10,
            ry: 10,
        });
        graph.nodes.push({
            label: "wtf",
            index: 0,
            width: 60,
            height: 40,
            //x: 250,
            //y: 50,
            rx: 10,
            ry: 10,
        });
        graph.nodes.push({
            label: "bbq",
            index: 0,
            width: 60,
            height: 40,
            //x: 250,
            //y: 50,
            rx: 10,
            ry: 10,
        });
        graph.links = [];
        graph.links.push({source: 0, target: 1, distance: 60, style: "link"})

        graph.groups = [];
        graph.groups.push({
            nodeID: 1,
            leaves: [0, 1],
            padding: 15,
            style: "fill:#ffdd3c;fill-opacity:0.37254902000000001;stroke:#ffdd3c;stroke-opacity:1",
        });
        graph.groups.push({
            nodeID: 2,
            leaves: [2],
            padding: 15,
            style: "fill:#ffdd3c;fill-opacity:0.37254902000000001;stroke:#ffdd3c;stroke-opacity:1",
        });

        graph.constraints = [];
        //var constraintMap = {};
        //sbsvg.selectAll('[relType=alignment]').each(function () {
        //    var cid = this.attributes['constraintID'].value;
        //    var nodeid = nodeLookup[this.attributes['objOneID'].value].index;
        //    var alignmentPos = this.attributes['alignmentPos'].value;
        //    var o = { node: nodeid, offset: 0 };
        //    if (cid in constraintMap) {
        //        constraintMap[cid].offsets.push(o);
        //    } else {
        //        graph.constraints.push(constraintMap[cid] = {
        //            type: 'alignment',
        //            offsets: [o],
        //            axis: alignmentPos == 1 ? "y" : "x"
        //        });
        //    }
        //});

        var color = d3.scale.category20();

        d3cola
            .nodes(graph.nodes)
            .links(graph.links)
            .groups(graph.groups)
            .constraints(graph.constraints)
            .start();//10, 15, 40);

        // define arrow markers for graph links
        outer.append('svg:defs').append('svg:marker')
            .attr('id', 'end-arrow')
            .attr('viewBox', '0 -5 10 10')
            .attr('refX', 5)
            .attr('markerWidth', 3)
            .attr('markerHeight', 3)
            .attr('orient', 'auto')
          .append('svg:path')
            .attr('d', 'M0,-5L10,0L0,5L2,0')
            .attr('stroke-width', '0px')
            .attr('fill', '#000');

        var group = groupsLayer.selectAll(".group")
            .data(graph.groups)
          .enter().append("rect")
            .attr("rx", 4).attr("ry", 4)
            .attr("class", "group")
            .style("fill-opacity", 0.4)
            //.attr("style", "fill:#ffdd3c;fill-opacity:0.37254902000000001;stroke:#ffdd3c;stroke-opacity:1")
            .style("fill", function (d) { return color(d.nodeID) })
            .call(d3cola.drag);

        var link = linksLayer.selectAll(".link")
            .data(graph.links)
          .enter().append("line")
            .attr("class", function (d) { return d.style; });
        //var link = linksLayer.selectAll(".link")
        //    .data(graph.links)
        //  .enter().append('svg:path')
        //    .attr("class", "link");

        var margin = 6, pad = 12;
        var node = nodesLayer.selectAll(".node")
            .data(graph.nodes)
          .enter().append("rect")
            .attr("class", "node")
            .attr("width", function (d) { return d.width + 2 * pad + 2 * margin; })
            .attr("height", function (d) { return d.height + 2 * pad + 2 * margin; })
            .attr("rx", function (d) { return d.rx; }).attr("ry", function (d) { return d.rx; })
            .call(d3cola.drag);

        var label = nodesLayer.selectAll(".label")
            .data(graph.nodes)
           .enter().append("text")
            .attr("class", "label")
            .call(d3cola.drag);

        var insertLinebreaks = function (d) {
            var el = d3.select(this);
            var words = d.label.split(' ');
            el.text('');

            for (var i = 0; i < words.length; i++) {
                var tspan = el.append('tspan').text(words[i]);
                tspan.attr('x', 0).attr('dy', '15')
                     .attr("font-size", "12");
            }
        };

        label.each(insertLinebreaks);

        var groupLabel = vis.selectAll(".groupLabel").data(graph.groups)
            .enter().append("text")
            .attr("font-size", "13")
            .text(function (d) { return "Node " + d.nodeID });

        node.append("title")
            .text(function (d) { return d.label; });

        d3cola.on("tick", function () {
            node.each(function (d) {
                d.innerBounds = d.bounds.inflate(- margin);
            });
            link.each(function (d) {
                d.route = cola.vpsc.makeEdgeBetween(d.source.innerBounds, d.target.innerBounds, 5);
                if (isIE())  this.parentNode.insertBefore(this, this);
            });
            
            link.attr("x1", function (d) { return d.route.sourceIntersection.x; })
                .attr("y1", function (d) { return d.route.sourceIntersection.y; })
                .attr("x2", function (d) { return d.route.arrowStart.x; })
                .attr("y2", function (d) { return d.route.arrowStart.y; });

            label.each(function (d) {
                var b = this.getBBox();
                d.width = b.width + 2 * margin + 8;
                d.height = b.height + 2 * margin + 8;
            });

            node.attr("x", function (d) { return d.innerBounds.x; })
                .attr("y", function (d) { return d.innerBounds.y; })
                .attr("width", function (d) { return d.innerBounds.width(); })
                .attr("height", function (d) { return d.innerBounds.height(); });

            group.attr("x", function (d) { return d.bounds.x; })
                 .attr("y", function (d) { return d.bounds.y; })
                 .attr("width", function (d) { return d.bounds.width(); })
                 .attr("height", function (d) { return d.bounds.height(); });


            groupLabel.data(group.data())
              .attr("x", function(d) { return d.bounds.x + 5})
              .attr("y", function(d) { return d.bounds.y + 15});

            //groupLabel.attr("x", group.data()[0].bounds.x)
            //          .attr("y", group.data()[0].bounds.y);

            label.attr("transform", function (d) {
                return "translate(" + d.x + margin + "," + (d.y + margin - d.height/2) + ")";
            });
        });
    }
    function isIE() { return ((navigator.appName == 'Microsoft Internet Explorer') || ((navigator.appName == 'Netscape') && (new RegExp("Trident/.*rv:([0-9]{1,}[\.0-9]{0,})").exec(navigator.userAgent) != null))); }
</script>
</body>
</html>
