<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Workload</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link rel="stylesheet" href="https://unpkg.com/uplot@1.6.9/dist/uPlot.min.css">
    <style>
      .uplot {
        display: inline-block;
        vertical-align: top;
      }
    </style>
  </head>
  <body>
    <script src="https://unpkg.com/uplot@1.6.9/dist/uPlot.iife.js"></script>
    <script src="distbucket.js"></script>

    <br>

    <font size="3"><b>
    <table style="border-spacing: 10px 0; margin-left: 50px">
      <tr>
        <td>Refill rate:</td>
        <td><input id="rate_per_sec" type="number" style="width: 80px" min="0" value="240"/></td>
      </tr>
      <tr>
        <td>Initial burst:</td>
        <td><input id="initial_burst" type="number" style="width: 80px" min="0" value="100"/></td>
      </tr>
      <tr>
        <td>Max burst:</td>
        <td><input id="max_burst" type="number" style="width: 80px" min="0" value="100"/></td>
      </tr>
    </table>
    </b></font>


    <script>
      // configKeys are yaml fields and <input> ids.
      const configKeys = ["rate_per_sec", "initial_burst", "max_burst"];

      var plots = [];

      function makeCharts() {
        plots.forEach(function(plot) {
          plot.destroy()
        })
        plots = [];

        const workloadYAML = `
nodes:
  - funcs:
     - type: constant
       value: 100

     - type: ramp
       start: 5
       duration: 10
       delta: 50

     - type: ramp
       start: 25
       duration: 2
       delta: -50

  - funcs:
     - type: constant
       value: 50

     - type: ramp
       start: 10
       duration: 10
       delta: 100

     - type: ramp
       start: 20
       duration: 5
       delta: -60

     - type: ramp
       start: 27
       duration: 1
       delta: -40

  - funcs:
     - type: sine
       period: 10
       peak: 100
`
        var inputYAML = workloadYAML;
        inputYAML += "config:\n";
        configKeys.forEach(function(key) {
          var elem = document.getElementById(key);
          inputYAML += "  " + key + ": " + elem.value + "\n";
        })
        console.log(inputYAML);

        var output = Process(inputYAML);


        const colors = [ "red", "green", "blue", "brown", "magenta", "orange" ];
        var colorIdx = 0;

        function getColor() {
          var c = colors[colorIdx];
          colorIdx = (colorIdx + 1) % colors.length;
          return c
        }

        output.Charts.forEach(function (chart) {
          const series = chart.Series;
          const data = [ output.TimeAxis ].concat(series.map(s => s.Data));
          const cursorOpts = {
            lock: true,
            ocus: {
              prox: 16,
            },
            sync: {
              key: "moo",
            },
          };

          const opts = {
            title: chart.Title,
            width: 1000,
            height: 400,
            focus: {
              alpha: 0.3,
            },
            scales: {
              x: {
                time: false,
               },
            },
            cursor: cursorOpts,
            series: [ { label: "Time (s)" } ].concat(series.map(function(s, idx) {
              return {
                  label: s.Name,
                  value: (u, v) => v.toFixed(1) + " " + s.Unit,
                  stroke: getColor(),
              }
            })),
            axes: [
              {},
              {
                values: (u, vals, space) => vals.map(v => v.toFixed(1)),
              },
            ],
          };

          plots.push(new uPlot(opts, data, document.body));
        })
      }
      makeCharts();
      configKeys.forEach(function(key) {
        var elem = document.getElementById(key);
        elem.onchange = function() {
          makeCharts()
        }
      })

      //document.getElementById("rate").innerHTML = input.RatePerSec + " RU/s"
      //document.getElementById("initial_burst").innerHTML = input.InitialBurst + " RU"
      //document.getElementById("max_burst").innerHTML = input.MaxBurst + " RU"



      const config = window.location.search.substring(1);
        document.title = document.title + " (" + config + ")"

      //fetch("output/" + config + ".json").then(r => r.json()).then(input => {
			//	makeCharts(input);
      //  document.getElementById("rate").innerHTML = input.RatePerSec + " RU/s"
      //  document.getElementById("initial_burst").innerHTML = input.InitialBurst + " RU"
      //  document.getElementById("max_burst").innerHTML = input.MaxBurst + " RU"
      //});

    </script>
  </body>
</html>
